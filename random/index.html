<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Moth</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Georgia, serif; background-color: #faf9f7; color: #2d2d2d; padding: 40px 20px 100px 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        /* Hamburger Menu */
        .menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .menu-toggle span { display: block; width: 20px; height: 2px; background: #2d2d2d; margin: 4px 0; }
        .menu { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: left 0.3s; z-index: 999; padding: 80px 20px 20px; }
        .menu.open { left: 0; }
        .menu a { display: block; padding: 15px 10px; color: #2d2d2d; text-decoration: none; border-bottom: 1px solid #eee; }
        .menu a:hover { color: #6b705c; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 998; display: none; }
        .menu-overlay.open { display: block; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-weight: normal; font-size: 2em; margin-bottom: 10px; }
        .subtitle { color: #888; font-size: 1em; margin-bottom: 20px; }
        .moth-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 500px; width: 100%; position: relative; }
        .moth-container img { width: 100%; height: 350px; object-fit: cover; cursor: pointer; }
        .moth-info { padding: 20px; text-align: center; }
        .moth-name { font-size: 1.4em; margin-bottom: 5px; }
        .moth-name a { color: #2d2d2d; text-decoration: none; }
        .moth-name a:hover { color: #6b705c; }
        .scientific-name { font-style: italic; color: #666; margin-bottom: 10px; }
        .family { font-size: 0.9em; color: #555; margin-bottom: 5px; }
        .location { font-size: 0.9em; color: #888; }
        .button { background: #6b705c; color: white; border: none; padding: 12px 50px; font-size: 1em; font-family: Georgia, serif; border-radius: 6px; cursor: pointer; transition: background 0.2s; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
        .button:hover { background: #5a5f4e; }
        .button:disabled { background: #aaa; cursor: wait; }
        .loading { text-align: center; padding: 60px; color: #888; }
        a { color: #6b705c; }
        
        /* Heart icon */
        .heart { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; opacity: 0.8; transition: all 0.2s; display: none; color: white; text-shadow: 0 0 3px rgba(0,0,0,0.5); }
        .heart:hover { transform: scale(1.1); opacity: 1; }
        .heart.favorited { color: #e74c3c; text-shadow: none; }
        .admin-mode .heart { display: block; }
    </style>
</head>
<body>
    <div class="menu-toggle" onclick="toggleMenu()">
        <span></span><span></span><span></span>
    </div>
    <div class="menu-overlay" onclick="toggleMenu()"></div>
    <nav class="menu">
        <a href="/">ü¶ã Home</a>
        <a href="/random">üé≤ Random Moth</a>
        <a href="/best">‚≠ê Best Moths</a>
    </nav>
    
    <header>
        <h1>üé≤ Random Moth üé≤</h1>
        <p class="subtitle">Discover a new moth with each button press.</p>
    </header>
    <div id="moth" class="moth-container">
        <div class="loading">Hit the button to find a moth!</div>
    </div>
    <button id="randomize" class="button" onclick="fetchRandomMoth()">ü¶ã Find a Moth ü¶ã</button>
    <script>
        const GIST_ID = '13f60f151dac089590b88b9a55c4140e';
        const WORKER_URL = 'https://moth-favorites.masondandrus.workers.dev/';
        const ADMIN_SECRET = 'mothsrock';
        
        let isAdmin = false;
        let currentMoth = null;
        let favorites = [];
        
        function toggleMenu() {
            document.querySelector('.menu').classList.toggle('open');
            document.querySelector('.menu-overlay').classList.toggle('open');
        }
        
        function checkAdmin() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('admin') === ADMIN_SECRET) {
                isAdmin = true;
                localStorage.setItem('mothAdmin', 'true');
            } else if (localStorage.getItem('mothAdmin') === 'true') {
                isAdmin = true;
            }
            if (isAdmin) {
                document.body.classList.add('admin-mode');
            }
        }
        
        async function loadFavorites() {
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);
                const gist = await response.json();
                if (gist.files['favorites.json']) {
                    favorites = JSON.parse(gist.files['favorites.json'].content);
                }
            } catch (err) {
                console.log('No favorites yet');
            }
        }
        
        async function toggleFavorite() {
            if (!isAdmin || !currentMoth) return;
            
            const heart = document.querySelector('.heart');
            const isFav = favorites.includes(currentMoth.id);
            
            if (isFav) {
                // Remove from favorites
                favorites = favorites.filter(id => id !== currentMoth.id);
                heart.classList.remove('favorited');
                heart.textContent = '‚ô°';
                
                await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ favorites })
                });
            } else {
                // Add to favorites AND collection
                favorites.push(currentMoth.id);
                heart.classList.add('favorited');
                heart.textContent = '‚ô•';
                
                await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ favorites, newMoth: currentMoth })
                });
            }
        }
        
        async function getFamilyInfo(taxonId) {
            if (!taxonId) return null;
            try {
                const response = await fetch(`https://api.inaturalist.org/v1/taxa/${taxonId}`);
                const data = await response.json();
                const taxon = data.results?.[0];
                if (!taxon?.ancestors) return null;
                for (const ancestor of taxon.ancestors) {
                    if (ancestor.rank === 'family') {
                        const familyName = ancestor.name || '';
                        const familyCommon = ancestor.preferred_common_name || '';
                        if (familyCommon) return `${familyName} ‚Äî ${familyCommon}`;
                        return familyName;
                    }
                }
            } catch (err) {
                return null;
            }
            return null;
        }

        async function fetchRandomMoth() {
            const button = document.getElementById('randomize');
            const container = document.getElementById('moth');
            button.disabled = true;
            button.textContent = 'Searching...';
            container.innerHTML = '<div class="loading">Finding a moth...</div>';
            
            try {
                const params = new URLSearchParams({
                    taxon_id: 47157,
                    quality_grade: 'research',
                    photos: 'true',
                    photo_licensed: 'true',
                    per_page: 50,
                    order_by: 'random',
                    without_taxon_id: 47224
                });
                const response = await fetch(`https://api.inaturalist.org/v1/observations?${params}`);
                const data = await response.json();
                const withNames = data.results.filter(m => m.taxon?.preferred_common_name);
                if (!withNames.length) {
                    container.innerHTML = '<div class="loading">No moths found, try again!</div>';
                    return;
                }
                const moth = withNames[Math.floor(Math.random() * withNames.length)];
                const photo = moth.photos[0];
                let photoUrl = photo.url.replace('square', 'large').replace('small', 'large').replace('medium', 'large').replace('thumb', 'large');
                const taxon = moth.taxon || {};
                const taxonId = taxon.id;
                const commonName = taxon.preferred_common_name || 'Unknown moth';
                const scientificName = taxon.name || 'Species unknown';
                const place = moth.place_guess || 'Location unknown';
                const obsUrl = `https://www.inaturalist.org/observations/${moth.id}`;
                
                const family = await getFamilyInfo(taxonId);
                
                // Store current moth for favoriting
                currentMoth = {
                    id: moth.id,
                    photo_url: photoUrl,
                    common_name: commonName,
                    scientific_name: scientificName,
                    place: place,
                    observation_url: obsUrl,
                    attribution: photo.attribution || 'Unknown photographer',
                    observations_count: taxon.observations_count || 0,
                    family: family
                };
                
                const isFav = favorites.includes(moth.id);
                
                container.innerHTML = `
                    <span class="heart ${isFav ? 'favorited' : ''}" onclick="toggleFavorite()">${isFav ? '‚ô•' : '‚ô°'}</span>
                    <a href="${obsUrl}" target="_blank">
                        <img src="${photoUrl}" alt="${commonName}">
                    </a>
                    <div class="moth-info">
                        <div class="moth-name"><a href="${obsUrl}" target="_blank">${commonName}</a></div>
                        <div class="scientific-name">${scientificName}</div>
                        ${family ? `<div class="family">Family: ${family}</div>` : ''}
                        <div class="location">üìç ${place}</div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<div class="loading">Error fetching moth. Try again!</div>';
            } finally {
                button.disabled = false;
                button.textContent = 'ü¶ã Find Another Moth ü¶ã';
            }
        }
        
        checkAdmin();
        loadFavorites();
    </script>
</body>
</html>
